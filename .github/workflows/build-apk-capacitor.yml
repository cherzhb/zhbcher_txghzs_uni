name: Build Android APK with Capacitor

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      version_name:
        description: 'ç‰ˆæœ¬å· (å¦‚: 1.0.1)'
        required: false
        default: '1.0.0'
      release_notes:
        description: 'å‘å¸ƒè¯´æ˜Ž'
        required: false

env:
  APP_ID: uni.TXGHZS
  APP_NAME: é€€ä¼‘è§„åˆ’åŠ©æ‰‹

jobs:
  build-apk:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      
    - name: Install dependencies
      run: |
        npm install --legacy-peer-deps
        
    - name: Install Capacitor
      run: |
        npm install -D @capacitor/core @capacitor/cli @capacitor/android
        npx cap sync
        
    - name: Build uni-app for H5
      run: |
        # å…ˆæž„å»º H5 ç‰ˆæœ¬ï¼Œè¿™æ˜¯ Capacitor éœ€è¦çš„èµ„æº
        npm run build:h5
      env:
        NODE_ENV: production
        
    - name: Initialize Capacitor
      run: |
        # åˆå§‹åŒ– Capacitor é¡¹ç›®
        npx cap init "é€€ä¼‘è§„åˆ’åŠ©æ‰‹" "${{ env.APP_ID }}" --web-dir=dist/build/h5
      env:
        CAPACITOR_GRAPH_CLIENT_TOKEN: ${{ secrets.CAPACITOR_TOKEN }}
        
    - name: Add Android platform
      run: |
        # æ·»åŠ  Android å¹³å°
        npx cap add android
        
        # åŒæ­¥ Web èµ„æºåˆ° Android é¡¹ç›®
        npx cap sync android
        
    - name: Setup Gradle
      uses: gradle/gradle-build-action@v3
      
    - name: Update Android manifest and build configs
      run: |
        # æ›´æ–° AndroidManifest.xml æƒé™
        mkdir -p android/app/src/main
        cat > android/app/src/main/AndroidManifest.xml << 'EOF'
        <?xml version="1.0" encoding="utf-8"?>
        <manifest xmlns:android="http://schemas.android.com/apk/res/android"
            android:versionCode="100"
            android:versionName="1.0.0">
            
            <uses-permission android:name="android.permission.INTERNET" />
            <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />
            
            <application
                android:allowBackup="true"
                android:icon="@mipmap/ic_launcher"
                android:label="é€€ä¼‘è§„åˆ’åŠ©æ‰‹"
                android:theme="@style/AppTheme">
                
                <activity
                    android:name="io.ionic.starter.MainActivity"
                    android:configChanges="orientation|keyboardHidden|keyboard|screenSize|locale|smallestScreenSize|screenLayout|uiMode"
                    android:label="@string/app_name"
                    android:theme="@style/AppTheme"
                    android:exported="true">
                    
                    <intent-filter>
                        <action android:name="android.intent.action.MAIN" />
                        <category android:name="android.intent.category.LAUNCHER" />
                    </intent-filter>
                </activity>
            </application>
        </manifest>
        EOF
        
        # æ›´æ–° strings.xml
        mkdir -p android/app/src/main/res/values
        cat > android/app/src/main/res/values/strings.xml << 'EOF'
        <?xml version="1.0" encoding="utf-8"?>
        <resources>
            <string name="app_name">é€€ä¼‘è§„åˆ’åŠ©æ‰‹</string>
            <string name="title_activity_main">é€€ä¼‘è§„åˆ’åŠ©æ‰‹</string>
        </resources>
        EOF
        
    - name: Set version from input
      run: |
        VERSION="${{ github.event.inputs.version_name }}"
        if [ -z "$VERSION" ]; then
          VERSION="1.0.0"
        fi
        echo "APP_VERSION=$VERSION" >> $GITHUB_ENV
        
        # æ›´æ–° version in build.gradle
        sed -i "s/versionName .*/versionName \"$VERSION\"/" android/app/build.gradle
        sed -i "s/versionCode .*/versionCode ${GITHUB_RUN_NUMBER}/" android/app/build.gradle
        
    - name: Build Debug APK
      run: |
        cd android
        chmod +x gradlew
        ./gradlew assembleDebug --stacktrace
      continue-on-error: true
      
    - name: Build Release APK (if debug fails)
      if: failure()
      run: |
        cd android
        ./gradlew assembleRelease --stacktrace || true
        
    - name: Prepare output
      run: |
        mkdir -p output
        
        # æŸ¥æ‰¾å¹¶å¤åˆ¶ APK æ–‡ä»¶
        if [ -f "android/app/build/outputs/apk/debug/app-debug.apk" ]; then
          cp android/app/build/outputs/apk/debug/app-debug.apk output/é€€ä¼‘è§„åˆ’åŠ©æ‰‹-${{ env.APP_VERSION }}-debug.apk
          echo "âœ… Debug APK æž„å»ºæˆåŠŸ"
          APK_SIZE=$(stat -f%z "output/é€€ä¼‘è§„åˆ’åŠ©æ‰‹-${{ env.APP_VERSION }}-debug.apk" 2>/dev/null || stat -c%s "output/é€€ä¼‘è§„åˆ’åŠ©æ‰‹-${{ env.APP_VERSION }}-debug.apk" 2>/dev/null)
          echo "APK Size: $(echo "$APK_SIZE / 1024 / 1024" | bc) MB"
        fi
        
        if [ -f "android/app/build/outputs/apk/release/app-release-unsigned.apk" ]; then
          cp android/app/build/outputs/apk/release/app-release-unsigned.apk output/é€€ä¼‘è§„åˆ’åŠ©æ‰‹-${{ env.APP_VERSION }}-release-unsigned.apk
          echo "âœ… Release APK æž„å»ºæˆåŠŸï¼ˆæœªç­¾åï¼‰"
        fi
        
        # åˆ›å»ºæž„å»ºä¿¡æ¯
        cat > output/BUILD_INFO.md << EOF
        # é€€ä¼‘è§„åˆ’åŠ©æ‰‹ APK æž„å»ºæŠ¥å‘Š
        
        ## æž„å»ºä¿¡æ¯
        - **ç‰ˆæœ¬**: ${{ env.APP_VERSION }}
        - **æž„å»ºæ—¶é—´**: $(date)
        - **Commit**: ${{ github.sha }}
        - **Actions Run**: #${{ github.run_number }}
        
        ## æž„å»ºäº§ç‰©
        
        EOF
        
        if [ -f "output/é€€ä¼‘è§„åˆ’åŠ©æ‰‹-${{ env.APP_VERSION }}-debug.apk" ]; then
          echo "### âœ… APK æ–‡ä»¶" >> output/BUILD_INFO.md
          echo "- æ–‡ä»¶å: é€€ä¼‘è§„åˆ’åŠ©æ‰‹-${{ env.APP_VERSION }}-debug.apk" >> output/BUILD_INFO.md
          echo "- ç±»åž‹: Debugï¼ˆå¯ä»¥å®‰è£…ï¼Œç”¨äºŽæµ‹è¯•ï¼‰" >> output/BUILD_INFO.md
          echo "" >> output/BUILD_INFO.md
        fi
        
        cat >> output/BUILD_INFO.md << EOF
        ## å®‰è£…è¯´æ˜Ž
        
        1. ä¸‹è½½ APK æ–‡ä»¶
        2. åœ¨ Android è®¾å¤‡ä¸Šå¯ç”¨"æœªçŸ¥æ¥æº"å®‰è£…
        3. ç‚¹å‡» APK æ–‡ä»¶å®‰è£…
        
        ## æž„å»ºæ–¹å¼
        
        æœ¬ APK ä½¿ç”¨ä»¥ä¸‹æµç¨‹æž„å»ºï¼š
        1. GitHub Actions è§¦å‘æž„å»º
        2. uni-app æž„å»º H5 ç‰ˆæœ¬
        3. Capacitor å°† H5 èµ„æºåŒ…è£…ä¸ºåŽŸç”Ÿåº”ç”¨
        4. Android Gradle ç¼–è¯‘ç”Ÿæˆ APK
        
        ä¼˜ç‚¹ï¼š
        - âœ… å®Œå…¨äº‘ç«¯æ“ä½œï¼Œæ— éœ€æœ¬åœ°çŽ¯å¢ƒ
        - âœ… è‡ªåŠ¨åŒ–æž„å»ºï¼ŒæŽ¨é€åˆ° main åˆ†æ”¯å³è§¦å‘
        - âœ… æ— éœ€ä»˜è´¹çš„ DCloud äº‘æ‰“åŒ…æœåŠ¡
        - âœ… æž„å»ºäº§ç‰©ç›´æŽ¥ä»Ž GitHub Actions ä¸‹è½½
        
        æ³¨æ„ï¼š
        - è¿™æ˜¯ä¸€ä¸ª H5 åŒ…è£…çš„åŽŸç”Ÿåº”ç”¨ï¼Œæ€§èƒ½å¯èƒ½ç•¥ä½ŽäºŽåŽŸç”ŸåŒ…
        - å¦‚éœ€ä¼˜åŒ–å¯ä»¥è€ƒè™‘ä½¿ç”¨ç¦»çº¿åŒ…æˆ–å…¶ä»–æŠ€æœ¯
        EOF
        
        echo "=== è¾“å‡ºæ–‡ä»¶åˆ—è¡¨ ==="
        ls -lh output/
        
    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: txghzs-apk-v${{ env.APP_VERSION }}
        path: output/*.apk
        retention-days: 90
        
    - name: Upload build info
      uses: actions/upload-artifact@v4
      with:
        name: txghzs-build-info-v${{ env.APP_VERSION }}
        path: output/BUILD_INFO.md
        retention-days: 90
        
    - name: Create Build Summary
      if: always()
      run: |
        echo "## ðŸ”¨ æž„å»ºå®Œæˆ
        " >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| é¡¹ç›® | ä¿¡æ¯ |" >> $GITHUB_STEP_SUMMARY
        echo "|------|------|" >> $GITHUB_STEP_SUMMARY
        echo "| App åç§° | é€€ä¼‘è§„åˆ’åŠ©æ‰‹ |" >> $GITHUB_STEP_SUMMARY
        echo "| ç‰ˆæœ¬ | ${{ env.APP_VERSION }} |" >> $GITHUB_STEP_SUMMARY
        echo "| æž„å»º # | ${{ github.run_number }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Commit | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "output/é€€ä¼‘è§„åˆ’åŠ©æ‰‹-${{ env.APP_VERSION }}-debug.apk" ]; then
          echo "### âœ… APK å·²ç”Ÿæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "è¯·ä»Ž Actions artifacts ä¸‹è½½ï¼š" >> $GITHUB_STEP_SUMMARY
          echo "- \`txghzs-apk-v${{ env.APP_VERSION }}\` - APK æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
          echo "- \`txghzs-build-info-v${{ env.APP_VERSION }}\` - æž„å»ºè¯¦æƒ…" >> $GITHUB_STEP_SUMMARY
        else
          echo "### âš ï¸ APK ç”Ÿæˆå¤±è´¥" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "è¯·æŸ¥çœ‹æž„å»ºæ—¥å¿—æŽ’æŸ¥é—®é¢˜" >> $GITHUB_STEP_SUMMARY
        fi
