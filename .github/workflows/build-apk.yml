name: Build Android APK

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      android_cert_alias:
        description: 'Android certificate alias (optional)'
        required: false
      android_cert_password:
        description: 'Android certificate password (optional)'
        required: false

env:
  APP_ID: __UNI__TXGHZS
  APP_NAME: é€€ä¼‘è§„åˆ’åŠ©æ‰‹

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: npm install --legacy-peer-deps
      
    - name: Build uni-app for App
      run: |
        npx cross-env NODE_ENV=production UNI_PLATFORM=app-plus npx vite build
      env:
        UNI_INPUT_DIR: src
        UNI_OUTPUT_DIR: dist/build/app-plus
        
    - name: Prepare app resources
      run: |
        # ç¡®ä¿ manifest.json åœ¨æ­£ç¡®ä½ç½®
        mkdir -p dist/build/app-plus
        cp src/manifest.json dist/build/app-plus/ 2>/dev/null || true
        
        echo "=== App ä¿¡æ¯ ==="
        echo "App ID: $APP_ID"
        echo "App Name: $APP_NAME"
        cat src/manifest.json | grep -E '"appid"|"versionName"|"versionCode"'
        
    - name: Create APK package info
      run: |
        cat > dist/build/app-plus/package.json << 'PKGEOF'
        {
          "name": "txghzs-app",
          "appid": "__UNI__TXGHZS",
          "description": "é€€ä¼‘è§„åˆ’åŠ©æ‰‹",
          "versionName": "1.0.0",
          "versionCode": "100"
        }
        PKGEOF
        
    - name: Setup Java for Android SDK
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: Download HBuilderX (Linux)
      run: |
        cd /tmp
        wget -q "https://download1.dcloud.net.cn/download/HBuilderX.4.08.2025012107.linux.tar.gz" -O hbuilderx.tar.gz || true
        tar -xzf hbuilderx.tar.gz 2>/dev/null || echo "HBuilderX download/extract failed"
        ls -la /tmp/HBuilderX 2>/dev/null || echo "HBuilderX not available"
      continue-on-error: true
        
    - name: Try HBuilderX CLI pack
      run: |
        if [ -f "/tmp/HBuilderX/plugins/uniapp-cli/bin/uniapp-cli" ]; then
          echo "Using HBuilderX CLI..."
          /tmp/HBuilderX/plugins/uniapp-cli/bin/uniapp-cli pack --platform APP-ANDROID --project . --timeout 600
        else
          echo "HBuilderX CLI not available, using alternative method..."
        fi
      continue-on-error: true
        
    - name: Collect build outputs
      run: |
        mkdir -p output
        
        # æŸ¥æ‰¾æ‰€æœ‰å¯èƒ½çš„ APK æ–‡ä»¶
        find . -name "*.apk" -type f -exec cp {} output/ \; 2>/dev/null || true
        
        # å¤åˆ¶æ„å»ºäº§ç‰©
        cp -r dist/build/app-plus/* output/ 2>/dev/null || true
        
        # åˆ›å»ºæ„å»ºä¿¡æ¯
        cat > output/BUILD_INFO.txt << EOF
        App ID: $APP_ID
        App Name: $APP_NAME
        Build Date: $(date)
        Build Runner: GitHub Actions
        
        æ‰“åŒ…è¯´æ˜ï¼š
        å¦‚æœæ²¡æœ‰ç”Ÿæˆ APK æ–‡ä»¶ï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹æ–¹å¼æ‰“åŒ…ï¼š
        1. ä¸‹è½½ output æ–‡ä»¶å¤¹
        2. ä½¿ç”¨ HBuilderX æ‰“å¼€é¡¹ç›®
        3. å‘è¡Œ -> åŸç”ŸApp-äº‘æ‰“åŒ…
        4. æˆ–è®¿é—® https://dev.dcloud.net.cn/ åœ¨çº¿æ‰“åŒ…
        EOF
        
        echo "=== æ„å»ºç»“æœ ==="
        ls -la output/
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: txghzs-app-build
        path: output/
        retention-days: 7
        
    - name: Check for APK
      id: check_apk
      run: |
        if ls output/*.apk 1> /dev/null 2>&1; then
          echo "apk_found=true" >> $GITHUB_OUTPUT
          echo "âœ… APK æ„å»ºæˆåŠŸï¼"
          ls -la output/*.apk
        else
          echo "apk_found=false" >> $GITHUB_OUTPUT
          echo "âš ï¸ APK æœªç”Ÿæˆï¼Œéœ€è¦ä½¿ç”¨ DCloud äº‘æ‰“åŒ…æœåŠ¡"
        fi
        
    - name: Notify build status
      if: always()
      run: |
        echo "=========================================="
        echo "ğŸ“± æ„å»ºå®Œæˆ"
        echo "=========================================="
        echo "App ID: $APP_ID"
        echo ""
        if [ "${{ steps.check_apk.outputs.apk_found }}" == "true" ]; then
          echo "âœ… APK å·²ç”Ÿæˆï¼Œè¯·ä» Actions artifacts ä¸‹è½½"
        else
          echo "âš ï¸ éœ€è¦æ‰‹åŠ¨å®Œæˆæ‰“åŒ…ï¼š"
          echo "1. ä¸‹è½½æ„å»ºäº§ç‰© (txghzs-app-build)"
          echo "2. ä½¿ç”¨ HBuilderX æˆ– DCloud å¼€å‘è€…ä¸­å¿ƒæ‰“åŒ…"
          echo "   https://dev.dcloud.net.cn/"
        fi
        echo "=========================================="
